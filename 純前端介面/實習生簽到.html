<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>實習生簽到表系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(79, 195, 247, 0.1), 0 1px 3px rgba(79, 195, 247, 0.08);
            overflow: hidden;
            min-height: 90vh;
            border: 1px solid #b3e5fc;
        }

        .header {
            background: linear-gradient(135deg, #81d4fa 0%, #4fc3f7 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .current-time {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #e1f5fe;
            border-bottom: 1px solid #b3e5fc;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: #4fc3f7;
            color: white;
            border-bottom: 3px solid #29b6f6;
        }

        .nav-tab:hover:not(.active) {
            background: #b3e5fc;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e1f5fe;
            border-left: 4px solid #4fc3f7;
        }

        .btn {
            background: #4fc3f7;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            margin: 5px;
            font-weight: 500;
        }

        .btn:hover {
            background: #29b6f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(79, 195, 247, 0.3);
        }

        .btn-success {
            background: #81d4fa;
        }

        .btn-success:hover {
            background: #4fc3f7;
            box-shadow: 0 2px 8px rgba(129, 212, 250, 0.3);
        }

        .btn-warning {
            background: #90caf9;
        }

        .btn-warning:hover {
            background: #64b5f6;
            box-shadow: 0 2px 8px rgba(144, 202, 249, 0.3);
        }

        .btn-danger {
            background: #b3e5fc;
            color: #01579b;
        }

        .btn-danger:hover {
            background: #81d4fa;
            box-shadow: 0 2px 8px rgba(179, 229, 252, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #b3e5fc;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s ease;
            background: #f1f8fd;
        }

        .form-control:focus {
            outline: none;
            border-color: #4fc3f7;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.1);
        }

        .status-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-item {
            background: #4fc3f7;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .status-item h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1f5fe;
            color: #0277bd;
        }

        .table th {
            background: #e1f5fe;
            font-weight: 600;
            color: #01579b;
            border-bottom: 2px solid #b3e5fc;
        }

        .table tr:hover {
            background: #f1f8fd;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .attendance-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-present {
            background: #e1f5fe;
            color: #01579b;
        }

        .status-absent {
            background: #ffebee;
            color: #c62828;
        }

        .status-late {
            background: #fff3e0;
            color: #e65100;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .nav-tab {
                font-size: 14px;
                padding: 12px 15px;
            }
            
            .tab-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>實習生簽到表系統</h1>
            <div class="current-time" id="currentTime"></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('checkin')">簽到簽退</button>
            <button class="nav-tab" onclick="showTab('hours')">時數查詢</button>
            <button class="nav-tab" onclick="showTab('anomaly')">異常管理</button>
            <button class="nav-tab" onclick="showTab('makeup')">補簽申請</button>
            <button class="nav-tab" onclick="showTab('reports')">出勤報表</button>
            <button class="nav-tab" onclick="showTab('settings')">系統設定</button>
        </div>

        <!-- 簽到簽退頁面 -->
        <div id="checkin" class="tab-content active">
            <div class="card">
                <h2>今日出勤狀態</h2>
                <div class="status-card">
                    <div class="status-item">
                        <h3 id="checkinTime">未簽到</h3>
                        <p>上班簽到時間</p>
                    </div>
                    <div class="status-item">
                        <h3 id="checkoutTime">未簽退</h3>
                        <p>下班簽退時間</p>
                    </div>
                    <div class="status-item">
                        <h3 id="todayHours">0.0</h3>
                        <p>今日實習時數</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-success" onclick="checkin()" id="checkinBtn">上班簽到</button>
                    <button class="btn btn-warning" onclick="checkout()" id="checkoutBtn" disabled>下班簽退</button>
                </div>
                
                <div id="locationInfo" style="text-align: center; margin-top: 20px; color: #6c757d;">
                    <small>定位中...</small>
                </div>
            </div>
        </div>

        <!-- 時數查詢頁面 -->
        <div id="hours" class="tab-content">
            <div class="card">
                <h2>實習時數統計</h2>
                <div class="status-card">
                    <div class="status-item">
                        <h3 id="totalHours">0</h3>
                        <p>累計實習時數</p>
                    </div>
                    <div class="status-item">
                        <h3 id="thisMonthHours">0</h3>
                        <p>本月實習時數</p>
                    </div>
                    <div class="status-item">
                        <h3 id="avgDailyHours">0</h3>
                        <p>平均日實習時數</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>查詢期間：</label>
                    <input type="date" id="startDate" class="form-control" style="width: 200px; display: inline-block;">
                    至
                    <input type="date" id="endDate" class="form-control" style="width: 200px; display: inline-block;">
                    <button class="btn" onclick="queryHours()">查詢</button>
                    <button class="btn" onclick="exportHours()">匯出報表</button>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>簽到時間</th>
                            <th>簽退時間</th>
                            <th>實習時數</th>
                            <th>狀態</th>
                        </tr>
                    </thead>
                    <tbody id="hoursTableBody">
                        <!-- 動態生成內容 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 異常管理頁面 -->
        <div id="anomaly" class="tab-content">
            <div class="card">
                <h2>出勤異常管理</h2>
                <div class="status-card">
                    <div class="status-item">
                        <h3 id="lateCount">0</h3>
                        <p>遲到次數</p>
                    </div>
                    <div class="status-item">
                        <h3 id="earlyLeaveCount">0</h3>
                        <p>早退次數</p>
                    </div>
                    <div class="status-item">
                        <h3 id="absentCount">0</h3>
                        <p>未簽到次數</p>
                    </div>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>異常類型</th>
                            <th>詳細說明</th>
                            <th>處理狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="anomalyTableBody">
                        <!-- 動態生成內容 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 補簽申請頁面 -->
        <div id="makeup" class="tab-content">
            <div class="card">
                <h2>補簽申請</h2>
                <form onsubmit="submitMakeupRequest(event)">
                    <div class="form-group">
                        <label>補簽日期：</label>
                        <input type="date" id="makeupDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>補簽類型：</label>
                        <select id="makeupType" class="form-control" required>
                            <option value="">請選擇</option>
                            <option value="checkin">補簽到</option>
                            <option value="checkout">補簽退</option>
                            <option value="both">補簽到與簽退</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>應簽到時間：</label>
                        <input type="time" id="makeupCheckinTime" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label>應簽退時間：</label>
                        <input type="time" id="makeupCheckoutTime" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label>漏簽原因：</label>
                        <textarea id="makeupReason" class="form-control" rows="4" required placeholder="請詳細說明漏簽的原因..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>相關證明文件：</label>
                        <input type="file" id="makeupDocument" class="form-control" accept=".jpg,.jpeg,.png,.pdf">
                    </div>
                    
                    <button type="submit" class="btn">提交申請</button>
                </form>
            </div>
            
            <div class="card">
                <h3>補簽申請記錄</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>申請日期</th>
                            <th>補簽日期</th>
                            <th>類型</th>
                            <th>審核狀態</th>
                            <th>審核意見</th>
                        </tr>
                    </thead>
                    <tbody id="makeupTableBody">
                        <!-- 動態生成內容 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 出勤報表頁面 -->
        <div id="reports" class="tab-content">
            <div class="card">
                <h2>出勤報表產生</h2>
                
                <div class="form-group">
                    <label>報表類型：</label>
                    <select id="reportType" class="form-control">
                        <option value="personal">個人實習時數報表</option>
                        <option value="summary">實習生出勤整合統計報表</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>報表期間：</label>
                    <input type="date" id="reportStartDate" class="form-control" style="width: 200px; display: inline-block;">
                    至
                    <input type="date" id="reportEndDate" class="form-control" style="width: 200px; display: inline-block;">
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn" onclick="generateReport()">產生報表</button>
                    <button class="btn" onclick="previewReport()">預覽報表</button>
                    <button class="btn" onclick="downloadReport()">下載報表</button>
                </div>
                
                <div id="reportPreview" style="margin-top: 30px; display: none;">
                    <h3>報表預覽</h3>
                    <div id="reportContent"></div>
                </div>
            </div>
        </div>

        <!-- 系統設定頁面 -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h2>時間參數設定</h2>
                
                <div class="form-group">
                    <label>員工姓名：</label>
                    <input type="text" id="employeeName" class="form-control" placeholder="請輸入員工姓名">
                </div>
                
                <div class="form-group">
                    <label>學校：</label>
                    <input type="text" id="schoolName" class="form-control" placeholder="請輸入學校名稱">
                </div>
                
                <div class="form-group">
                    <label>科系：</label>
                    <input type="text" id="departmentName" class="form-control" placeholder="請輸入科系名稱">
                </div>
                
                <div class="form-group">
                    <label>上班時間：</label>
                    <input type="time" id="workStartTime" class="form-control" value="09:00">
                </div>
                
                <div class="form-group">
                    <label>下班時間：</label>
                    <input type="time" id="workEndTime" class="form-control" value="18:00">
                </div>
                
                <div class="form-group">
                    <label>彈性時間範圍（分鐘）：</label>
                    <input type="number" id="flexTimeRange" class="form-control" value="15" min="0" max="60">
                </div>
                
                <div class="form-group">
                    <label>工時類型：</label>
                    <select id="workType" class="form-control">
                        <option value="fulltime">全職</option>
                        <option value="parttime">兼職</option>
                        <option value="flexible">彈性工時</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>午休時間（小時）：</label>
                    <input type="number" id="lunchBreak" class="form-control" value="1" min="0" max="3" step="0.5">
                </div>
                
                <button class="btn" onclick="saveAllSettings()">儲存所有設定</button>
                <button class="btn" onclick="resetSettings()">重設為預設值</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">系統訊息</h3>
            <p id="modalMessage"></p>
            <button class="btn" onclick="closeModal()">確定</button>
        </div>
    </div>

    <script>
        // 系統資料儲存
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
        let anomalyData = JSON.parse(localStorage.getItem('anomalyData')) || [];
        let makeupRequests = JSON.parse(localStorage.getItem('makeupRequests')) || [];
        let systemSettings = JSON.parse(localStorage.getItem('systemSettings')) || {
            workStartTime: '09:00',
            workEndTime: '18:00',
            flexTimeRange: 15,
            workType: 'fulltime',
            lunchBreak: 1
        };

        // 初始化系統
        window.onload = function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            loadTodayStatus();
            loadSettings();
            getLocation();
            setDefaultDates();
        };

        // 更新當前時間
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
        }

        // 設定預設日期
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('startDate').value = weekAgo;
            document.getElementById('endDate').value = today;
            document.getElementById('reportStartDate').value = weekAgo;
            document.getElementById('reportEndDate').value = today;
        }

        // 頁籤切換
        function showTab(tabName) {
            // 隱藏所有頁籤內容
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // 移除所有頁籤按鈕的active類別
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // 顯示選中的頁籤
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // 根據不同頁籤載入對應資料
            switch(tabName) {
                case 'hours':
                    loadHoursData();
                    break;
                case 'anomaly':
                    loadAnomalyData();
                    break;
                case 'makeup':
                    loadMakeupData();
                    break;
            }
        }

        // 取得位置資訊
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        document.getElementById('locationInfo').innerHTML = 
                            `<small>📍 定位成功 (${lat.toFixed(6)}, ${lng.toFixed(6)})</small>`;
                    },
                    function(error) {
                        document.getElementById('locationInfo').innerHTML = 
                            '<small>⚠️ 無法取得位置資訊，請檢查定位權限</small>';
                    }
                );
            } else {
                document.getElementById('locationInfo').innerHTML = 
                    '<small>⚠️ 瀏覽器不支援定位功能</small>';
            }
        }

        // 上班簽到
        function checkin() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            // 檢查是否已經簽到
            const existingRecord = attendanceData.find(record => 
                record.date === today && record.checkinTime
            );
            
            if (existingRecord) {
                showModal('簽到失敗', '今日已經簽到過了！');
                return;
            }
            
            // 記錄簽到時間
            const checkinTime = now.toTimeString().split(' ')[0];
            const newRecord = {
                date: today,
                checkinTime: checkinTime,
                checkoutTime: null,
                totalHours: 0,
                status: '已簽到'
            };
            
            attendanceData.push(newRecord);
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // 更新介面
            document.getElementById('checkinTime').textContent = checkinTime;
            document.getElementById('checkinBtn').disabled = true;
            document.getElementById('checkoutBtn').disabled = false;
            
            // 檢查是否遲到
            const workStartTime = systemSettings.workStartTime;
            const startTime = new Date(`${today}T${workStartTime}`);
            const flexTime = systemSettings.flexTimeRange * 60 * 1000; // 轉換為毫秒
            
            if (now > new Date(startTime.getTime() + flexTime)) {
                addAnomalyRecord(today, '遲到', `遲到 ${Math.ceil((now - startTime) / 60000)} 分鐘`);
            }
            
            showModal('簽到成功', `簽到時間：${checkinTime}`);
        }

        // 下班簽退
        function checkout() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            // 尋找今日簽到記錄
            const recordIndex = attendanceData.findIndex(record => 
                record.date === today && record.checkinTime && !record.checkoutTime
            );
            
            if (recordIndex === -1) {
                showModal('簽退失敗', '請先完成上班簽到！');
                return;
            }
            
            // 記錄簽退時間
            const checkoutTime = now.toTimeString().split(' ')[0];
            const checkinTime = new Date(`${today}T${attendanceData[recordIndex].checkinTime}`);
            const checkoutDateTime = new Date(`${today}T${checkoutTime}`);
            
            // 計算實習時數（扣除午休時間）
            const totalMinutes = (checkoutDateTime - checkinTime) / (1000 * 60);
            const totalHours = Math.max(0, (totalMinutes - systemSettings.lunchBreak * 60) / 60);
            
            attendanceData[recordIndex].checkoutTime = checkoutTime;
            attendanceData[recordIndex].totalHours = Math.round(totalHours * 100) / 100;
            attendanceData[recordIndex].status = '已完成';
            
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // 更新介面
            document.getElementById('checkoutTime').textContent = checkoutTime;
            document.getElementById('todayHours').textContent = attendanceData[recordIndex].totalHours;
            document.getElementById('checkoutBtn').disabled = true;
            
            // 檢查是否早退
            const workEndTime = systemSettings.workEndTime;
            const endTime = new Date(`${today}T${workEndTime}`);
            
            if (checkoutDateTime < endTime) {
                addAnomalyRecord(today, '早退', `早退 ${Math.ceil((endTime - checkoutDateTime) / 60000)} 分鐘`);
            }
            
            showModal('簽退成功', `簽退時間：${checkoutTime}<br>今日實習時數：${attendanceData[recordIndex].totalHours} 小時`);
        }

        // 載入今日狀態
        function loadTodayStatus() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = attendanceData.find(record => record.date === today);
            
            if (todayRecord) {
                if (todayRecord.checkinTime) {
                    document.getElementById('checkinTime').textContent = todayRecord.checkinTime;
                    document.getElementById('checkinBtn').disabled = true;
                    document.getElementById('checkoutBtn').disabled = false;
                }
                
                if (todayRecord.checkoutTime) {
                    document.getElementById('checkoutTime').textContent = todayRecord.checkoutTime;
                    document.getElementById('todayHours').textContent = todayRecord.totalHours;
                    document.getElementById('checkoutBtn').disabled = true;
                }
            }
        }

        // 新增異常記錄
        function addAnomalyRecord(date, type, description) {
            const anomaly = {
                date: date,
                type: type,
                description: description,
                status: '待處理',
                createTime: new Date().toISOString()
            };
            
            anomalyData.push(anomaly);
            localStorage.setItem('anomalyData', JSON.stringify(anomalyData));
        }

        // 載入時數資料
        function loadHoursData() {
            // 計算統計資料
            const totalHours = attendanceData.reduce((sum, record) => sum + (record.totalHours || 0), 0);
            const thisMonth = new Date().toISOString().slice(0, 7);
            const thisMonthHours = attendanceData
                .filter(record => record.date.startsWith(thisMonth))
                .reduce((sum, record) => sum + (record.totalHours || 0), 0);
            const avgHours = attendanceData.length > 0 ? totalHours / attendanceData.length : 0;
            
            document.getElementById('totalHours').textContent = Math.round(totalHours * 100) / 100;
            document.getElementById('thisMonthHours').textContent = Math.round(thisMonthHours * 100) / 100;
            document.getElementById('avgDailyHours').textContent = Math.round(avgHours * 100) / 100;
            
            // 載入表格資料
            queryHours();
        }

        // 查詢時數
        function queryHours() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const filteredData = attendanceData.filter(record => {
                return record.date >= startDate && record.date <= endDate;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const tbody = document.getElementById('hoursTableBody');
            tbody.innerHTML = '';
            
            filteredData.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.checkinTime || '--'}</td>
                    <td>${record.checkoutTime || '--'}</td>
                    <td>${record.totalHours || 0}</td>
                    <td><span class="attendance-status ${getStatusClass(record.status)}">${record.status}</span></td>
                `;
            });
        }

        // 匯出時數報表
        function exportHours() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const filteredData = attendanceData.filter(record => {
                return record.date >= startDate && record.date <= endDate;
            });
            
            let csvContent = "日期,簽到時間,簽退時間,實習時數,狀態\n";
            filteredData.forEach(record => {
                csvContent += `${record.date},${record.checkinTime || ''},${record.checkoutTime || ''},${record.totalHours || 0},${record.status}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `實習時數報表_${startDate}_${endDate}.csv`;
            link.click();
        }

        // 載入異常資料
        function loadAnomalyData() {
            // 統計異常次數
            const lateCount = anomalyData.filter(a => a.type === '遲到').length;
            const earlyLeaveCount = anomalyData.filter(a => a.type === '早退').length;
            const absentCount = anomalyData.filter(a => a.type === '未簽到').length;
            
            document.getElementById('lateCount').textContent = lateCount;
            document.getElementById('earlyLeaveCount').textContent = earlyLeaveCount;
            document.getElementById('absentCount').textContent = absentCount;
            
            // 載入異常記錄表格
            const tbody = document.getElementById('anomalyTableBody');
            tbody.innerHTML = '';
            
            anomalyData.sort((a, b) => new Date(b.createTime) - new Date(a.createTime)).forEach((anomaly, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${anomaly.date}</td>
                    <td>${anomaly.type}</td>
                    <td>${anomaly.description}</td>
                    <td><span class="attendance-status ${getStatusClass(anomaly.status)}">${anomaly.status}</span></td>
                    <td>
                        ${anomaly.status === '待處理' ? 
                            `<button class="btn" onclick="resolveAnomaly(${index})">標記已處理</button>` : 
                            '已處理'
                        }
                    </td>
                `;
            });
        }

        // 處理異常
        function resolveAnomaly(index) {
            anomalyData[index].status = '已處理';
            anomalyData[index].resolveTime = new Date().toISOString();
            localStorage.setItem('anomalyData', JSON.stringify(anomalyData));
            loadAnomalyData();
            showModal('處理成功', '異常記錄已標記為已處理');
        }

        // 提交補簽申請
        function submitMakeupRequest(event) {
            event.preventDefault();
            
            const makeupDate = document.getElementById('makeupDate').value;
            const makeupType = document.getElementById('makeupType').value;
            const checkinTime = document.getElementById('makeupCheckinTime').value;
            const checkoutTime = document.getElementById('makeupCheckoutTime').value;
            const reason = document.getElementById('makeupReason').value;
            
            const request = {
                id: Date.now(),
                makeupDate: makeupDate,
                type: makeupType,
                checkinTime: checkinTime,
                checkoutTime: checkoutTime,
                reason: reason,
                status: '待審核',
                applyTime: new Date().toISOString(),
                reviewComment: ''
            };
            
            makeupRequests.push(request);
            localStorage.setItem('makeupRequests', JSON.stringify(makeupRequests));
            
            // 清空表單
            document.getElementById('makeupDate').value = '';
            document.getElementById('makeupType').value = '';
            document.getElementById('makeupCheckinTime').value = '';
            document.getElementById('makeupCheckoutTime').value = '';
            document.getElementById('makeupReason').value = '';
            
            loadMakeupData();
            showModal('申請成功', '補簽申請已提交，請等待主管審核');
        }

        // 載入補簽資料
        function loadMakeupData() {
            const tbody = document.getElementById('makeupTableBody');
            tbody.innerHTML = '';
            
            makeupRequests.sort((a, b) => new Date(b.applyTime) - new Date(a.applyTime)).forEach(request => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(request.applyTime).toLocaleDateString()}</td>
                    <td>${request.makeupDate}</td>
                    <td>${request.type}</td>
                    <td><span class="attendance-status ${getStatusClass(request.status)}">${request.status}</span></td>
                    <td>${request.reviewComment || '--'}</td>
                `;
            });
        }

        // 產生報表
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                showModal('錯誤', '請選擇報表期間');
                return;
            }
            
            const filteredData = attendanceData.filter(record => {
                return record.date >= startDate && record.date <= endDate;
            });
            
            let reportContent = '';
            
            if (reportType === 'personal') {
                const totalHours = filteredData.reduce((sum, record) => sum + (record.totalHours || 0), 0);
                const employeeName = localStorage.getItem('employeeName') || '實習生';
                const school = localStorage.getItem('schoolName') || '';
                const department = localStorage.getItem('departmentName') || '';
                
                reportContent = `
                    <h4>個人實習時數報表</h4>
                    <p><strong>實習生姓名：</strong>${employeeName}</p>
                    <p><strong>學校：</strong>${school}</p>
                    <p><strong>科系：</strong>${department}</p>
                    <p><strong>統計期間：</strong>${startDate} 至 ${endDate}</p>
                    <p><strong>實習總時數：</strong>${Math.round(totalHours * 100) / 100} 小時</p>
                    <p><strong>實習天數：</strong>${filteredData.length} 天</p>
                    <p><strong>平均日時數：</strong>${Math.round((totalHours / filteredData.length) * 100) / 100} 小時</p>
                `;
            } else {
                const totalHours = filteredData.reduce((sum, record) => sum + (record.totalHours || 0), 0);
                
                reportContent = `
                    <h4>實習生出勤整合統計報表</h4>
                    <p><strong>統計期間：</strong>${startDate} 至 ${endDate}</p>
                    <table class="table">
                        <tr><td>總實習時數</td><td>${Math.round(totalHours * 100) / 100} 小時</td></tr>
                        <tr><td>實習天數</td><td>${filteredData.length} 天</td></tr>
                        <tr><td>平均日時數</td><td>${Math.round((totalHours / filteredData.length) * 100) / 100} 小時</td></tr>
                        <tr><td>異常記錄</td><td>${anomalyData.length} 次</td></tr>
                        <tr><td>補簽申請</td><td>${makeupRequests.length} 次</td></tr>
                    </table>
                `;
            }
            
            document.getElementById('reportContent').innerHTML = reportContent;
            document.getElementById('reportPreview').style.display = 'block';
        }

        // 預覽報表
        function previewReport() {
            generateReport();
        }

        // 下載報表
        function downloadReport() {
            const reportContent = document.getElementById('reportContent').innerHTML;
            if (!reportContent) {
                showModal('錯誤', '請先產生報表');
                return;
            }
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>實習生出勤報表</title>
                    <style>
                        body { font-family: Microsoft JhengHei, sans-serif; margin: 20px; }
                        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        .table td { padding: 8px; border: 1px solid #ddd; }
                    </style>
                </head>
                <body>${reportContent}</body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `實習生出勤報表_${new Date().toISOString().split('T')[0]}.html`;
            link.click();
        }

        // 儲存所有設定（合併原本的設定和個人資料）
        function saveAllSettings() {
            systemSettings.workStartTime = document.getElementById('workStartTime').value;
            systemSettings.workEndTime = document.getElementById('workEndTime').value;
            systemSettings.flexTimeRange = parseInt(document.getElementById('flexTimeRange').value);
            systemSettings.workType = document.getElementById('workType').value;
            systemSettings.lunchBreak = parseFloat(document.getElementById('lunchBreak').value);
            
            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
            
            // 儲存個人資料
            localStorage.setItem('employeeName', document.getElementById('employeeName').value);
            localStorage.setItem('schoolName', document.getElementById('schoolName').value);
            localStorage.setItem('departmentName', document.getElementById('departmentName').value);
            
            showModal('設定成功', '所有設定已儲存');
        }

        // 重設設定
        function resetSettings() {
            document.getElementById('workStartTime').value = '09:00';
            document.getElementById('workEndTime').value = '18:00';
            document.getElementById('flexTimeRange').value = '15';
            document.getElementById('workType').value = 'fulltime';
            document.getElementById('lunchBreak').value = '1';
            document.getElementById('employeeName').value = '';
            document.getElementById('schoolName').value = '';
            document.getElementById('departmentName').value = '';
        }

        // 載入設定
        function loadSettings() {
            document.getElementById('workStartTime').value = systemSettings.workStartTime;
            document.getElementById('workEndTime').value = systemSettings.workEndTime;
            document.getElementById('flexTimeRange').value = systemSettings.flexTimeRange;
            document.getElementById('workType').value = systemSettings.workType;
            document.getElementById('lunchBreak').value = systemSettings.lunchBreak;
            
            // 載入個人資料
            document.getElementById('employeeName').value = localStorage.getItem('employeeName') || '';
            document.getElementById('schoolName').value = localStorage.getItem('schoolName') || '';
            document.getElementById('departmentName').value = localStorage.getItem('departmentName') || '';
        }

        // 刪除舊的 saveProfile 函數

        // 取得狀態樣式類別
        function getStatusClass(status) {
            switch(status) {
                case '已完成': case '已處理': case '審核通過':
                    return 'status-present';
                case '待處理': case '待審核':
                    return 'status-late';
                case '未簽到': case '審核拒絕':
                    return 'status-absent';
                default:
                    return 'status-late';
            }
        }

        // 顯示模態視窗
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('messageModal').style.display = 'block';
        }

        // 關閉模態視窗
        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        // 點擊視窗外部關閉模態視窗
        window.onclick = function(event) {
            const modal = document.getElementById('messageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // 每日自動檢查異常出勤（模擬）
        function dailyAnomalyCheck() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = attendanceData.find(record => record.date === today);
            
            // 檢查是否有當日記錄但未完整簽到簽退
            if (!todayRecord) {
                // 如果是工作日但沒有簽到記錄，標記為未簽到
                const dayOfWeek = new Date().getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) { // 週一到週五
                    addAnomalyRecord(today, '未簽到', '當日無簽到記錄');
                }
            } else if (todayRecord.checkinTime && !todayRecord.checkoutTime) {
                // 有簽到但沒簽退
                addAnomalyRecord(today, '未簽退', '有簽到記錄但無簽退記錄');
            }
        }

        // 模擬主管審核補簽申請（示例功能）
        function simulateManagerReview() {
            makeupRequests.forEach(request => {
                if (request.status === '待審核') {
                    // 隨機審核結果（實際應由主管操作）
                    const approved = Math.random() > 0.3;
                    request.status = approved ? '審核通過' : '審核拒絕';
                    request.reviewComment = approved ? '申請理由合理，核准補簽' : '申請理由不充分，請提供更多證明';
                    request.reviewTime = new Date().toISOString();
                    
                    // 如果審核通過，更新出勤記錄
                    if (approved) {
                        const existingRecord = attendanceData.find(record => record.date === request.makeupDate);
                        if (existingRecord) {
                            if (request.type === 'checkin' || request.type === 'both') {
                                existingRecord.checkinTime = request.checkinTime;
                            }
                            if (request.type === 'checkout' || request.type === 'both') {
                                existingRecord.checkoutTime = request.checkoutTime;
                                // 重新計算時數
                                if (existingRecord.checkinTime && existingRecord.checkoutTime) {
                                    const checkin = new Date(`${request.makeupDate}T${existingRecord.checkinTime}`);
                                    const checkout = new Date(`${request.makeupDate}T${existingRecord.checkoutTime}`);
                                    const totalMinutes = (checkout - checkin) / (1000 * 60);
                                    existingRecord.totalHours = Math.max(0, (totalMinutes - systemSettings.lunchBreak * 60) / 60);
                                    existingRecord.status = '已完成';
                                }
                            }
                        } else {
                            // 創建新的出勤記錄
                            const newRecord = {
                                date: request.makeupDate,
                                checkinTime: request.checkinTime || null,
                                checkoutTime: request.checkoutTime || null,
                                totalHours: 0,
                                status: '已完成'
                            };
                            
                            if (newRecord.checkinTime && newRecord.checkoutTime) {
                                const checkin = new Date(`${request.makeupDate}T${newRecord.checkinTime}`);
                                const checkout = new Date(`${request.makeupDate}T${newRecord.checkoutTime}`);
                                const totalMinutes = (checkout - checkin) / (1000 * 60);
                                newRecord.totalHours = Math.max(0, (totalMinutes - systemSettings.lunchBreak * 60) / 60);
                            }
                            
                            attendanceData.push(newRecord);
                        }
                        
                        localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                    }
                }
            });
            
            localStorage.setItem('makeupRequests', JSON.stringify(makeupRequests));
        }

        // 定期執行系統檢查
        setInterval(() => {
            dailyAnomalyCheck();
            simulateManagerReview();
        }, 60000); // 每分鐘檢查一次
    </script>
</body>
</html>