<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦ç¿’ç”Ÿç°½åˆ°è¡¨ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(79, 195, 247, 0.1), 0 1px 3px rgba(79, 195, 247, 0.08);
            overflow: hidden;
            min-height: 90vh;
            border: 1px solid #b3e5fc;
        }

        .header {
            background: linear-gradient(135deg, #81d4fa 0%, #4fc3f7 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .current-time {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #e1f5fe;
            border-bottom: 1px solid #b3e5fc;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: #4fc3f7;
            color: white;
            border-bottom: 3px solid #29b6f6;
        }

        .nav-tab:hover:not(.active) {
            background: #b3e5fc;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e1f5fe;
            border-left: 4px solid #4fc3f7;
        }

        .btn {
            background: #4fc3f7;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            margin: 5px;
            font-weight: 500;
        }

        .btn:hover {
            background: #29b6f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(79, 195, 247, 0.3);
        }

        .btn-success {
            background: #81d4fa;
        }

        .btn-success:hover {
            background: #4fc3f7;
            box-shadow: 0 2px 8px rgba(129, 212, 250, 0.3);
        }

        .btn-warning {
            background: #90caf9;
        }

        .btn-warning:hover {
            background: #64b5f6;
            box-shadow: 0 2px 8px rgba(144, 202, 249, 0.3);
        }

        .btn-danger {
            background: #b3e5fc;
            color: #01579b;
        }

        .btn-danger:hover {
            background: #81d4fa;
            box-shadow: 0 2px 8px rgba(179, 229, 252, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #b3e5fc;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s ease;
            background: #f1f8fd;
        }

        .form-control:focus {
            outline: none;
            border-color: #4fc3f7;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.1);
        }

        .status-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-item {
            background: #4fc3f7;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .status-item h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1f5fe;
            color: #0277bd;
        }

        .table th {
            background: #e1f5fe;
            font-weight: 600;
            color: #01579b;
            border-bottom: 2px solid #b3e5fc;
        }

        .table tr:hover {
            background: #f1f8fd;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .attendance-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-present {
            background: #e1f5fe;
            color: #01579b;
        }

        .status-absent {
            background: #ffebee;
            color: #c62828;
        }

        .status-late {
            background: #fff3e0;
            color: #e65100;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .nav-tab {
                font-size: 14px;
                padding: 12px 15px;
            }
            
            .tab-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å¯¦ç¿’ç”Ÿç°½åˆ°è¡¨ç³»çµ±</h1>
            <div class="current-time" id="currentTime"></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('checkin')">ç°½åˆ°ç°½é€€</button>
            <button class="nav-tab" onclick="showTab('hours')">æ™‚æ•¸æŸ¥è©¢</button>
            <button class="nav-tab" onclick="showTab('anomaly')">ç•°å¸¸ç®¡ç†</button>
            <button class="nav-tab" onclick="showTab('makeup')">è£œç°½ç”³è«‹</button>
            <button class="nav-tab" onclick="showTab('reports')">å‡ºå‹¤å ±è¡¨</button>
            <button class="nav-tab" onclick="showTab('settings')">ç³»çµ±è¨­å®š</button>
        </div>

        <!-- ç°½åˆ°ç°½é€€é é¢ -->
        <div id="checkin" class="tab-content active">
            <div class="card">
                <h2>ä»Šæ—¥å‡ºå‹¤ç‹€æ…‹</h2>
                <div class="status-card">
                    <div class="status-item">
                        <h3 id="checkinTime">æœªç°½åˆ°</h3>
                        <p>ä¸Šç­ç°½åˆ°æ™‚é–“</p>
                    </div>
                    <div class="status-item">
                        <h3 id="checkoutTime">æœªç°½é€€</h3>
                        <p>ä¸‹ç­ç°½é€€æ™‚é–“</p>
                    </div>
                    <div class="status-item">
                        <h3 id="todayHours">0.0</h3>
                        <p>ä»Šæ—¥å¯¦ç¿’æ™‚æ•¸</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-success" onclick="checkin()" id="checkinBtn">ä¸Šç­ç°½åˆ°</button>
                    <button class="btn btn-warning" onclick="checkout()" id="checkoutBtn" disabled>ä¸‹ç­ç°½é€€</button>
                </div>
                
                <div id="locationInfo" style="text-align: center; margin-top: 20px; color: #6c757d;">
                    <small>å®šä½ä¸­...</small>
                </div>
            </div>
        </div>

        <!-- æ™‚æ•¸æŸ¥è©¢é é¢ -->
        <div id="hours" class="tab-content">
            <div class="card">
                <h2>å¯¦ç¿’æ™‚æ•¸çµ±è¨ˆ</h2>
                <div class="status-card">
                    <div class="status-item">
                        <h3 id="totalHours">0</h3>
                        <p>ç´¯è¨ˆå¯¦ç¿’æ™‚æ•¸</p>
                    </div>
                    <div class="status-item">
                        <h3 id="thisMonthHours">0</h3>
                        <p>æœ¬æœˆå¯¦ç¿’æ™‚æ•¸</p>
                    </div>
                    <div class="status-item">
                        <h3 id="avgDailyHours">0</h3>
                        <p>å¹³å‡æ—¥å¯¦ç¿’æ™‚æ•¸</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>æŸ¥è©¢æœŸé–“ï¼š</label>
                    <input type="date" id="startDate" class="form-control" style="width: 200px; display: inline-block;">
                    è‡³
                    <input type="date" id="endDate" class="form-control" style="width: 200px; display: inline-block;">
                    <button class="btn" onclick="queryHours()">æŸ¥è©¢</button>
                    <button class="btn" onclick="exportHours()">åŒ¯å‡ºå ±è¡¨</button>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>ç°½åˆ°æ™‚é–“</th>
                            <th>ç°½é€€æ™‚é–“</th>
                            <th>å¯¦ç¿’æ™‚æ•¸</th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="hoursTableBody">
                        <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç•°å¸¸ç®¡ç†é é¢ -->
        <div id="anomaly" class="tab-content">
            <div class="card">
                <h2>å‡ºå‹¤ç•°å¸¸ç®¡ç†</h2>
                <div class="status-card">
                    <div class="status-item">
                        <h3 id="lateCount">0</h3>
                        <p>é²åˆ°æ¬¡æ•¸</p>
                    </div>
                    <div class="status-item">
                        <h3 id="earlyLeaveCount">0</h3>
                        <p>æ—©é€€æ¬¡æ•¸</p>
                    </div>
                    <div class="status-item">
                        <h3 id="absentCount">0</h3>
                        <p>æœªç°½åˆ°æ¬¡æ•¸</p>
                    </div>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>ç•°å¸¸é¡å‹</th>
                            <th>è©³ç´°èªªæ˜</th>
                            <th>è™•ç†ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="anomalyTableBody">
                        <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- è£œç°½ç”³è«‹é é¢ -->
        <div id="makeup" class="tab-content">
            <div class="card">
                <h2>è£œç°½ç”³è«‹</h2>
                <form onsubmit="submitMakeupRequest(event)">
                    <div class="form-group">
                        <label>è£œç°½æ—¥æœŸï¼š</label>
                        <input type="date" id="makeupDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>è£œç°½é¡å‹ï¼š</label>
                        <select id="makeupType" class="form-control" required>
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="checkin">è£œç°½åˆ°</option>
                            <option value="checkout">è£œç°½é€€</option>
                            <option value="both">è£œç°½åˆ°èˆ‡ç°½é€€</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>æ‡‰ç°½åˆ°æ™‚é–“ï¼š</label>
                        <input type="time" id="makeupCheckinTime" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label>æ‡‰ç°½é€€æ™‚é–“ï¼š</label>
                        <input type="time" id="makeupCheckoutTime" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label>æ¼ç°½åŸå› ï¼š</label>
                        <textarea id="makeupReason" class="form-control" rows="4" required placeholder="è«‹è©³ç´°èªªæ˜æ¼ç°½çš„åŸå› ..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>ç›¸é—œè­‰æ˜æ–‡ä»¶ï¼š</label>
                        <input type="file" id="makeupDocument" class="form-control" accept=".jpg,.jpeg,.png,.pdf">
                    </div>
                    
                    <button type="submit" class="btn">æäº¤ç”³è«‹</button>
                </form>
            </div>
            
            <div class="card">
                <h3>è£œç°½ç”³è«‹è¨˜éŒ„</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ç”³è«‹æ—¥æœŸ</th>
                            <th>è£œç°½æ—¥æœŸ</th>
                            <th>é¡å‹</th>
                            <th>å¯©æ ¸ç‹€æ…‹</th>
                            <th>å¯©æ ¸æ„è¦‹</th>
                        </tr>
                    </thead>
                    <tbody id="makeupTableBody">
                        <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å‡ºå‹¤å ±è¡¨é é¢ -->
        <div id="reports" class="tab-content">
            <div class="card">
                <h2>å‡ºå‹¤å ±è¡¨ç”¢ç”Ÿ</h2>
                
                <div class="form-group">
                    <label>å ±è¡¨é¡å‹ï¼š</label>
                    <select id="reportType" class="form-control">
                        <option value="personal">å€‹äººå¯¦ç¿’æ™‚æ•¸å ±è¡¨</option>
                        <option value="summary">å¯¦ç¿’ç”Ÿå‡ºå‹¤æ•´åˆçµ±è¨ˆå ±è¡¨</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>å ±è¡¨æœŸé–“ï¼š</label>
                    <input type="date" id="reportStartDate" class="form-control" style="width: 200px; display: inline-block;">
                    è‡³
                    <input type="date" id="reportEndDate" class="form-control" style="width: 200px; display: inline-block;">
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn" onclick="generateReport()">ç”¢ç”Ÿå ±è¡¨</button>
                    <button class="btn" onclick="previewReport()">é è¦½å ±è¡¨</button>
                    <button class="btn" onclick="downloadReport()">ä¸‹è¼‰å ±è¡¨</button>
                </div>
                
                <div id="reportPreview" style="margin-top: 30px; display: none;">
                    <h3>å ±è¡¨é è¦½</h3>
                    <div id="reportContent"></div>
                </div>
            </div>
        </div>

        <!-- ç³»çµ±è¨­å®šé é¢ -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h2>æ™‚é–“åƒæ•¸è¨­å®š</h2>
                
                <div class="form-group">
                    <label>å“¡å·¥å§“åï¼š</label>
                    <input type="text" id="employeeName" class="form-control" placeholder="è«‹è¼¸å…¥å“¡å·¥å§“å">
                </div>
                
                <div class="form-group">
                    <label>å­¸æ ¡ï¼š</label>
                    <input type="text" id="schoolName" class="form-control" placeholder="è«‹è¼¸å…¥å­¸æ ¡åç¨±">
                </div>
                
                <div class="form-group">
                    <label>ç§‘ç³»ï¼š</label>
                    <input type="text" id="departmentName" class="form-control" placeholder="è«‹è¼¸å…¥ç§‘ç³»åç¨±">
                </div>
                
                <div class="form-group">
                    <label>ä¸Šç­æ™‚é–“ï¼š</label>
                    <input type="time" id="workStartTime" class="form-control" value="09:00">
                </div>
                
                <div class="form-group">
                    <label>ä¸‹ç­æ™‚é–“ï¼š</label>
                    <input type="time" id="workEndTime" class="form-control" value="18:00">
                </div>
                
                <div class="form-group">
                    <label>å½ˆæ€§æ™‚é–“ç¯„åœï¼ˆåˆ†é˜ï¼‰ï¼š</label>
                    <input type="number" id="flexTimeRange" class="form-control" value="15" min="0" max="60">
                </div>
                
                <div class="form-group">
                    <label>å·¥æ™‚é¡å‹ï¼š</label>
                    <select id="workType" class="form-control">
                        <option value="fulltime">å…¨è·</option>
                        <option value="parttime">å…¼è·</option>
                        <option value="flexible">å½ˆæ€§å·¥æ™‚</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>åˆä¼‘æ™‚é–“ï¼ˆå°æ™‚ï¼‰ï¼š</label>
                    <input type="number" id="lunchBreak" class="form-control" value="1" min="0" max="3" step="0.5">
                </div>
                
                <button class="btn" onclick="saveAllSettings()">å„²å­˜æ‰€æœ‰è¨­å®š</button>
                <button class="btn" onclick="resetSettings()">é‡è¨­ç‚ºé è¨­å€¼</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">ç³»çµ±è¨Šæ¯</h3>
            <p id="modalMessage"></p>
            <button class="btn" onclick="closeModal()">ç¢ºå®š</button>
        </div>
    </div>

    <script>
        // ç³»çµ±è³‡æ–™å„²å­˜
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
        let anomalyData = JSON.parse(localStorage.getItem('anomalyData')) || [];
        let makeupRequests = JSON.parse(localStorage.getItem('makeupRequests')) || [];
        let systemSettings = JSON.parse(localStorage.getItem('systemSettings')) || {
            workStartTime: '09:00',
            workEndTime: '18:00',
            flexTimeRange: 15,
            workType: 'fulltime',
            lunchBreak: 1
        };

        // åˆå§‹åŒ–ç³»çµ±
        window.onload = function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            loadTodayStatus();
            loadSettings();
            getLocation();
            setDefaultDates();
        };

        // æ›´æ–°ç•¶å‰æ™‚é–“
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
        }

        // è¨­å®šé è¨­æ—¥æœŸ
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('startDate').value = weekAgo;
            document.getElementById('endDate').value = today;
            document.getElementById('reportStartDate').value = weekAgo;
            document.getElementById('reportEndDate').value = today;
        }

        // é ç±¤åˆ‡æ›
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰é ç±¤å…§å®¹
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰é ç±¤æŒ‰éˆ•çš„activeé¡åˆ¥
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // é¡¯ç¤ºé¸ä¸­çš„é ç±¤
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // æ ¹æ“šä¸åŒé ç±¤è¼‰å…¥å°æ‡‰è³‡æ–™
            switch(tabName) {
                case 'hours':
                    loadHoursData();
                    break;
                case 'anomaly':
                    loadAnomalyData();
                    break;
                case 'makeup':
                    loadMakeupData();
                    break;
            }
        }

        // å–å¾—ä½ç½®è³‡è¨Š
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        document.getElementById('locationInfo').innerHTML = 
                            `<small>ğŸ“ å®šä½æˆåŠŸ (${lat.toFixed(6)}, ${lng.toFixed(6)})</small>`;
                    },
                    function(error) {
                        document.getElementById('locationInfo').innerHTML = 
                            '<small>âš ï¸ ç„¡æ³•å–å¾—ä½ç½®è³‡è¨Šï¼Œè«‹æª¢æŸ¥å®šä½æ¬Šé™</small>';
                    }
                );
            } else {
                document.getElementById('locationInfo').innerHTML = 
                    '<small>âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½</small>';
            }
        }

        // ä¸Šç­ç°½åˆ°
        function checkin() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“ç°½åˆ°
            const existingRecord = attendanceData.find(record => 
                record.date === today && record.checkinTime
            );
            
            if (existingRecord) {
                showModal('ç°½åˆ°å¤±æ•—', 'ä»Šæ—¥å·²ç¶“ç°½åˆ°éäº†ï¼');
                return;
            }
            
            // è¨˜éŒ„ç°½åˆ°æ™‚é–“
            const checkinTime = now.toTimeString().split(' ')[0];
            const newRecord = {
                date: today,
                checkinTime: checkinTime,
                checkoutTime: null,
                totalHours: 0,
                status: 'å·²ç°½åˆ°'
            };
            
            attendanceData.push(newRecord);
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // æ›´æ–°ä»‹é¢
            document.getElementById('checkinTime').textContent = checkinTime;
            document.getElementById('checkinBtn').disabled = true;
            document.getElementById('checkoutBtn').disabled = false;
            
            // æª¢æŸ¥æ˜¯å¦é²åˆ°
            const workStartTime = systemSettings.workStartTime;
            const startTime = new Date(`${today}T${workStartTime}`);
            const flexTime = systemSettings.flexTimeRange * 60 * 1000; // è½‰æ›ç‚ºæ¯«ç§’
            
            if (now > new Date(startTime.getTime() + flexTime)) {
                addAnomalyRecord(today, 'é²åˆ°', `é²åˆ° ${Math.ceil((now - startTime) / 60000)} åˆ†é˜`);
            }
            
            showModal('ç°½åˆ°æˆåŠŸ', `ç°½åˆ°æ™‚é–“ï¼š${checkinTime}`);
        }

        // ä¸‹ç­ç°½é€€
        function checkout() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            // å°‹æ‰¾ä»Šæ—¥ç°½åˆ°è¨˜éŒ„
            const recordIndex = attendanceData.findIndex(record => 
                record.date === today && record.checkinTime && !record.checkoutTime
            );
            
            if (recordIndex === -1) {
                showModal('ç°½é€€å¤±æ•—', 'è«‹å…ˆå®Œæˆä¸Šç­ç°½åˆ°ï¼');
                return;
            }
            
            // è¨˜éŒ„ç°½é€€æ™‚é–“
            const checkoutTime = now.toTimeString().split(' ')[0];
            const checkinTime = new Date(`${today}T${attendanceData[recordIndex].checkinTime}`);
            const checkoutDateTime = new Date(`${today}T${checkoutTime}`);
            
            // è¨ˆç®—å¯¦ç¿’æ™‚æ•¸ï¼ˆæ‰£é™¤åˆä¼‘æ™‚é–“ï¼‰
            const totalMinutes = (checkoutDateTime - checkinTime) / (1000 * 60);
            const totalHours = Math.max(0, (totalMinutes - systemSettings.lunchBreak * 60) / 60);
            
            attendanceData[recordIndex].checkoutTime = checkoutTime;
            attendanceData[recordIndex].totalHours = Math.round(totalHours * 100) / 100;
            attendanceData[recordIndex].status = 'å·²å®Œæˆ';
            
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // æ›´æ–°ä»‹é¢
            document.getElementById('checkoutTime').textContent = checkoutTime;
            document.getElementById('todayHours').textContent = attendanceData[recordIndex].totalHours;
            document.getElementById('checkoutBtn').disabled = true;
            
            // æª¢æŸ¥æ˜¯å¦æ—©é€€
            const workEndTime = systemSettings.workEndTime;
            const endTime = new Date(`${today}T${workEndTime}`);
            
            if (checkoutDateTime < endTime) {
                addAnomalyRecord(today, 'æ—©é€€', `æ—©é€€ ${Math.ceil((endTime - checkoutDateTime) / 60000)} åˆ†é˜`);
            }
            
            showModal('ç°½é€€æˆåŠŸ', `ç°½é€€æ™‚é–“ï¼š${checkoutTime}<br>ä»Šæ—¥å¯¦ç¿’æ™‚æ•¸ï¼š${attendanceData[recordIndex].totalHours} å°æ™‚`);
        }

        // è¼‰å…¥ä»Šæ—¥ç‹€æ…‹
        function loadTodayStatus() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = attendanceData.find(record => record.date === today);
            
            if (todayRecord) {
                if (todayRecord.checkinTime) {
                    document.getElementById('checkinTime').textContent = todayRecord.checkinTime;
                    document.getElementById('checkinBtn').disabled = true;
                    document.getElementById('checkoutBtn').disabled = false;
                }
                
                if (todayRecord.checkoutTime) {
                    document.getElementById('checkoutTime').textContent = todayRecord.checkoutTime;
                    document.getElementById('todayHours').textContent = todayRecord.totalHours;
                    document.getElementById('checkoutBtn').disabled = true;
                }
            }
        }

        // æ–°å¢ç•°å¸¸è¨˜éŒ„
        function addAnomalyRecord(date, type, description) {
            const anomaly = {
                date: date,
                type: type,
                description: description,
                status: 'å¾…è™•ç†',
                createTime: new Date().toISOString()
            };
            
            anomalyData.push(anomaly);
            localStorage.setItem('anomalyData', JSON.stringify(anomalyData));
        }

        // è¼‰å…¥æ™‚æ•¸è³‡æ–™
        function loadHoursData() {
            // è¨ˆç®—çµ±è¨ˆè³‡æ–™
            const totalHours = attendanceData.reduce((sum, record) => sum + (record.totalHours || 0), 0);
            const thisMonth = new Date().toISOString().slice(0, 7);
            const thisMonthHours = attendanceData
                .filter(record => record.date.startsWith(thisMonth))
                .reduce((sum, record) => sum + (record.totalHours || 0), 0);
            const avgHours = attendanceData.length > 0 ? totalHours / attendanceData.length : 0;
            
            document.getElementById('totalHours').textContent = Math.round(totalHours * 100) / 100;
            document.getElementById('thisMonthHours').textContent = Math.round(thisMonthHours * 100) / 100;
            document.getElementById('avgDailyHours').textContent = Math.round(avgHours * 100) / 100;
            
            // è¼‰å…¥è¡¨æ ¼è³‡æ–™
            queryHours();
        }

        // æŸ¥è©¢æ™‚æ•¸
        function queryHours() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const filteredData = attendanceData.filter(record => {
                return record.date >= startDate && record.date <= endDate;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const tbody = document.getElementById('hoursTableBody');
            tbody.innerHTML = '';
            
            filteredData.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.checkinTime || '--'}</td>
                    <td>${record.checkoutTime || '--'}</td>
                    <td>${record.totalHours || 0}</td>
                    <td><span class="attendance-status ${getStatusClass(record.status)}">${record.status}</span></td>
                `;
            });
        }

        // åŒ¯å‡ºæ™‚æ•¸å ±è¡¨
        function exportHours() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const filteredData = attendanceData.filter(record => {
                return record.date >= startDate && record.date <= endDate;
            });
            
            let csvContent = "æ—¥æœŸ,ç°½åˆ°æ™‚é–“,ç°½é€€æ™‚é–“,å¯¦ç¿’æ™‚æ•¸,ç‹€æ…‹\n";
            filteredData.forEach(record => {
                csvContent += `${record.date},${record.checkinTime || ''},${record.checkoutTime || ''},${record.totalHours || 0},${record.status}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å¯¦ç¿’æ™‚æ•¸å ±è¡¨_${startDate}_${endDate}.csv`;
            link.click();
        }

        // è¼‰å…¥ç•°å¸¸è³‡æ–™
        function loadAnomalyData() {
            // çµ±è¨ˆç•°å¸¸æ¬¡æ•¸
            const lateCount = anomalyData.filter(a => a.type === 'é²åˆ°').length;
            const earlyLeaveCount = anomalyData.filter(a => a.type === 'æ—©é€€').length;
            const absentCount = anomalyData.filter(a => a.type === 'æœªç°½åˆ°').length;
            
            document.getElementById('lateCount').textContent = lateCount;
            document.getElementById('earlyLeaveCount').textContent = earlyLeaveCount;
            document.getElementById('absentCount').textContent = absentCount;
            
            // è¼‰å…¥ç•°å¸¸è¨˜éŒ„è¡¨æ ¼
            const tbody = document.getElementById('anomalyTableBody');
            tbody.innerHTML = '';
            
            anomalyData.sort((a, b) => new Date(b.createTime) - new Date(a.createTime)).forEach((anomaly, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${anomaly.date}</td>
                    <td>${anomaly.type}</td>
                    <td>${anomaly.description}</td>
                    <td><span class="attendance-status ${getStatusClass(anomaly.status)}">${anomaly.status}</span></td>
                    <td>
                        ${anomaly.status === 'å¾…è™•ç†' ? 
                            `<button class="btn" onclick="resolveAnomaly(${index})">æ¨™è¨˜å·²è™•ç†</button>` : 
                            'å·²è™•ç†'
                        }
                    </td>
                `;
            });
        }

        // è™•ç†ç•°å¸¸
        function resolveAnomaly(index) {
            anomalyData[index].status = 'å·²è™•ç†';
            anomalyData[index].resolveTime = new Date().toISOString();
            localStorage.setItem('anomalyData', JSON.stringify(anomalyData));
            loadAnomalyData();
            showModal('è™•ç†æˆåŠŸ', 'ç•°å¸¸è¨˜éŒ„å·²æ¨™è¨˜ç‚ºå·²è™•ç†');
        }

        // æäº¤è£œç°½ç”³è«‹
        function submitMakeupRequest(event) {
            event.preventDefault();
            
            const makeupDate = document.getElementById('makeupDate').value;
            const makeupType = document.getElementById('makeupType').value;
            const checkinTime = document.getElementById('makeupCheckinTime').value;
            const checkoutTime = document.getElementById('makeupCheckoutTime').value;
            const reason = document.getElementById('makeupReason').value;
            
            const request = {
                id: Date.now(),
                makeupDate: makeupDate,
                type: makeupType,
                checkinTime: checkinTime,
                checkoutTime: checkoutTime,
                reason: reason,
                status: 'å¾…å¯©æ ¸',
                applyTime: new Date().toISOString(),
                reviewComment: ''
            };
            
            makeupRequests.push(request);
            localStorage.setItem('makeupRequests', JSON.stringify(makeupRequests));
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('makeupDate').value = '';
            document.getElementById('makeupType').value = '';
            document.getElementById('makeupCheckinTime').value = '';
            document.getElementById('makeupCheckoutTime').value = '';
            document.getElementById('makeupReason').value = '';
            
            loadMakeupData();
            showModal('ç”³è«‹æˆåŠŸ', 'è£œç°½ç”³è«‹å·²æäº¤ï¼Œè«‹ç­‰å¾…ä¸»ç®¡å¯©æ ¸');
        }

        // è¼‰å…¥è£œç°½è³‡æ–™
        function loadMakeupData() {
            const tbody = document.getElementById('makeupTableBody');
            tbody.innerHTML = '';
            
            makeupRequests.sort((a, b) => new Date(b.applyTime) - new Date(a.applyTime)).forEach(request => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(request.applyTime).toLocaleDateString()}</td>
                    <td>${request.makeupDate}</td>
                    <td>${request.type}</td>
                    <td><span class="attendance-status ${getStatusClass(request.status)}">${request.status}</span></td>
                    <td>${request.reviewComment || '--'}</td>
                `;
            });
        }

        // ç”¢ç”Ÿå ±è¡¨
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                showModal('éŒ¯èª¤', 'è«‹é¸æ“‡å ±è¡¨æœŸé–“');
                return;
            }
            
            const filteredData = attendanceData.filter(record => {
                return record.date >= startDate && record.date <= endDate;
            });
            
            let reportContent = '';
            
            if (reportType === 'personal') {
                const totalHours = filteredData.reduce((sum, record) => sum + (record.totalHours || 0), 0);
                const employeeName = localStorage.getItem('employeeName') || 'å¯¦ç¿’ç”Ÿ';
                const school = localStorage.getItem('schoolName') || '';
                const department = localStorage.getItem('departmentName') || '';
                
                reportContent = `
                    <h4>å€‹äººå¯¦ç¿’æ™‚æ•¸å ±è¡¨</h4>
                    <p><strong>å¯¦ç¿’ç”Ÿå§“åï¼š</strong>${employeeName}</p>
                    <p><strong>å­¸æ ¡ï¼š</strong>${school}</p>
                    <p><strong>ç§‘ç³»ï¼š</strong>${department}</p>
                    <p><strong>çµ±è¨ˆæœŸé–“ï¼š</strong>${startDate} è‡³ ${endDate}</p>
                    <p><strong>å¯¦ç¿’ç¸½æ™‚æ•¸ï¼š</strong>${Math.round(totalHours * 100) / 100} å°æ™‚</p>
                    <p><strong>å¯¦ç¿’å¤©æ•¸ï¼š</strong>${filteredData.length} å¤©</p>
                    <p><strong>å¹³å‡æ—¥æ™‚æ•¸ï¼š</strong>${Math.round((totalHours / filteredData.length) * 100) / 100} å°æ™‚</p>
                `;
            } else {
                const totalHours = filteredData.reduce((sum, record) => sum + (record.totalHours || 0), 0);
                
                reportContent = `
                    <h4>å¯¦ç¿’ç”Ÿå‡ºå‹¤æ•´åˆçµ±è¨ˆå ±è¡¨</h4>
                    <p><strong>çµ±è¨ˆæœŸé–“ï¼š</strong>${startDate} è‡³ ${endDate}</p>
                    <table class="table">
                        <tr><td>ç¸½å¯¦ç¿’æ™‚æ•¸</td><td>${Math.round(totalHours * 100) / 100} å°æ™‚</td></tr>
                        <tr><td>å¯¦ç¿’å¤©æ•¸</td><td>${filteredData.length} å¤©</td></tr>
                        <tr><td>å¹³å‡æ—¥æ™‚æ•¸</td><td>${Math.round((totalHours / filteredData.length) * 100) / 100} å°æ™‚</td></tr>
                        <tr><td>ç•°å¸¸è¨˜éŒ„</td><td>${anomalyData.length} æ¬¡</td></tr>
                        <tr><td>è£œç°½ç”³è«‹</td><td>${makeupRequests.length} æ¬¡</td></tr>
                    </table>
                `;
            }
            
            document.getElementById('reportContent').innerHTML = reportContent;
            document.getElementById('reportPreview').style.display = 'block';
        }

        // é è¦½å ±è¡¨
        function previewReport() {
            generateReport();
        }

        // ä¸‹è¼‰å ±è¡¨
        function downloadReport() {
            const reportContent = document.getElementById('reportContent').innerHTML;
            if (!reportContent) {
                showModal('éŒ¯èª¤', 'è«‹å…ˆç”¢ç”Ÿå ±è¡¨');
                return;
            }
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>å¯¦ç¿’ç”Ÿå‡ºå‹¤å ±è¡¨</title>
                    <style>
                        body { font-family: Microsoft JhengHei, sans-serif; margin: 20px; }
                        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        .table td { padding: 8px; border: 1px solid #ddd; }
                    </style>
                </head>
                <body>${reportContent}</body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å¯¦ç¿’ç”Ÿå‡ºå‹¤å ±è¡¨_${new Date().toISOString().split('T')[0]}.html`;
            link.click();
        }

        // å„²å­˜æ‰€æœ‰è¨­å®šï¼ˆåˆä½µåŸæœ¬çš„è¨­å®šå’Œå€‹äººè³‡æ–™ï¼‰
        function saveAllSettings() {
            systemSettings.workStartTime = document.getElementById('workStartTime').value;
            systemSettings.workEndTime = document.getElementById('workEndTime').value;
            systemSettings.flexTimeRange = parseInt(document.getElementById('flexTimeRange').value);
            systemSettings.workType = document.getElementById('workType').value;
            systemSettings.lunchBreak = parseFloat(document.getElementById('lunchBreak').value);
            
            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
            
            // å„²å­˜å€‹äººè³‡æ–™
            localStorage.setItem('employeeName', document.getElementById('employeeName').value);
            localStorage.setItem('schoolName', document.getElementById('schoolName').value);
            localStorage.setItem('departmentName', document.getElementById('departmentName').value);
            
            showModal('è¨­å®šæˆåŠŸ', 'æ‰€æœ‰è¨­å®šå·²å„²å­˜');
        }

        // é‡è¨­è¨­å®š
        function resetSettings() {
            document.getElementById('workStartTime').value = '09:00';
            document.getElementById('workEndTime').value = '18:00';
            document.getElementById('flexTimeRange').value = '15';
            document.getElementById('workType').value = 'fulltime';
            document.getElementById('lunchBreak').value = '1';
            document.getElementById('employeeName').value = '';
            document.getElementById('schoolName').value = '';
            document.getElementById('departmentName').value = '';
        }

        // è¼‰å…¥è¨­å®š
        function loadSettings() {
            document.getElementById('workStartTime').value = systemSettings.workStartTime;
            document.getElementById('workEndTime').value = systemSettings.workEndTime;
            document.getElementById('flexTimeRange').value = systemSettings.flexTimeRange;
            document.getElementById('workType').value = systemSettings.workType;
            document.getElementById('lunchBreak').value = systemSettings.lunchBreak;
            
            // è¼‰å…¥å€‹äººè³‡æ–™
            document.getElementById('employeeName').value = localStorage.getItem('employeeName') || '';
            document.getElementById('schoolName').value = localStorage.getItem('schoolName') || '';
            document.getElementById('departmentName').value = localStorage.getItem('departmentName') || '';
        }

        // åˆªé™¤èˆŠçš„ saveProfile å‡½æ•¸

        // å–å¾—ç‹€æ…‹æ¨£å¼é¡åˆ¥
        function getStatusClass(status) {
            switch(status) {
                case 'å·²å®Œæˆ': case 'å·²è™•ç†': case 'å¯©æ ¸é€šé':
                    return 'status-present';
                case 'å¾…è™•ç†': case 'å¾…å¯©æ ¸':
                    return 'status-late';
                case 'æœªç°½åˆ°': case 'å¯©æ ¸æ‹’çµ•':
                    return 'status-absent';
                default:
                    return 'status-late';
            }
        }

        // é¡¯ç¤ºæ¨¡æ…‹è¦–çª—
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('messageModal').style.display = 'block';
        }

        // é—œé–‰æ¨¡æ…‹è¦–çª—
        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        // é»æ“Šè¦–çª—å¤–éƒ¨é—œé–‰æ¨¡æ…‹è¦–çª—
        window.onclick = function(event) {
            const modal = document.getElementById('messageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // æ¯æ—¥è‡ªå‹•æª¢æŸ¥ç•°å¸¸å‡ºå‹¤ï¼ˆæ¨¡æ“¬ï¼‰
        function dailyAnomalyCheck() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = attendanceData.find(record => record.date === today);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ç•¶æ—¥è¨˜éŒ„ä½†æœªå®Œæ•´ç°½åˆ°ç°½é€€
            if (!todayRecord) {
                // å¦‚æœæ˜¯å·¥ä½œæ—¥ä½†æ²’æœ‰ç°½åˆ°è¨˜éŒ„ï¼Œæ¨™è¨˜ç‚ºæœªç°½åˆ°
                const dayOfWeek = new Date().getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) { // é€±ä¸€åˆ°é€±äº”
                    addAnomalyRecord(today, 'æœªç°½åˆ°', 'ç•¶æ—¥ç„¡ç°½åˆ°è¨˜éŒ„');
                }
            } else if (todayRecord.checkinTime && !todayRecord.checkoutTime) {
                // æœ‰ç°½åˆ°ä½†æ²’ç°½é€€
                addAnomalyRecord(today, 'æœªç°½é€€', 'æœ‰ç°½åˆ°è¨˜éŒ„ä½†ç„¡ç°½é€€è¨˜éŒ„');
            }
        }

        // æ¨¡æ“¬ä¸»ç®¡å¯©æ ¸è£œç°½ç”³è«‹ï¼ˆç¤ºä¾‹åŠŸèƒ½ï¼‰
        function simulateManagerReview() {
            makeupRequests.forEach(request => {
                if (request.status === 'å¾…å¯©æ ¸') {
                    // éš¨æ©Ÿå¯©æ ¸çµæœï¼ˆå¯¦éš›æ‡‰ç”±ä¸»ç®¡æ“ä½œï¼‰
                    const approved = Math.random() > 0.3;
                    request.status = approved ? 'å¯©æ ¸é€šé' : 'å¯©æ ¸æ‹’çµ•';
                    request.reviewComment = approved ? 'ç”³è«‹ç†ç”±åˆç†ï¼Œæ ¸å‡†è£œç°½' : 'ç”³è«‹ç†ç”±ä¸å……åˆ†ï¼Œè«‹æä¾›æ›´å¤šè­‰æ˜';
                    request.reviewTime = new Date().toISOString();
                    
                    // å¦‚æœå¯©æ ¸é€šéï¼Œæ›´æ–°å‡ºå‹¤è¨˜éŒ„
                    if (approved) {
                        const existingRecord = attendanceData.find(record => record.date === request.makeupDate);
                        if (existingRecord) {
                            if (request.type === 'checkin' || request.type === 'both') {
                                existingRecord.checkinTime = request.checkinTime;
                            }
                            if (request.type === 'checkout' || request.type === 'both') {
                                existingRecord.checkoutTime = request.checkoutTime;
                                // é‡æ–°è¨ˆç®—æ™‚æ•¸
                                if (existingRecord.checkinTime && existingRecord.checkoutTime) {
                                    const checkin = new Date(`${request.makeupDate}T${existingRecord.checkinTime}`);
                                    const checkout = new Date(`${request.makeupDate}T${existingRecord.checkoutTime}`);
                                    const totalMinutes = (checkout - checkin) / (1000 * 60);
                                    existingRecord.totalHours = Math.max(0, (totalMinutes - systemSettings.lunchBreak * 60) / 60);
                                    existingRecord.status = 'å·²å®Œæˆ';
                                }
                            }
                        } else {
                            // å‰µå»ºæ–°çš„å‡ºå‹¤è¨˜éŒ„
                            const newRecord = {
                                date: request.makeupDate,
                                checkinTime: request.checkinTime || null,
                                checkoutTime: request.checkoutTime || null,
                                totalHours: 0,
                                status: 'å·²å®Œæˆ'
                            };
                            
                            if (newRecord.checkinTime && newRecord.checkoutTime) {
                                const checkin = new Date(`${request.makeupDate}T${newRecord.checkinTime}`);
                                const checkout = new Date(`${request.makeupDate}T${newRecord.checkoutTime}`);
                                const totalMinutes = (checkout - checkin) / (1000 * 60);
                                newRecord.totalHours = Math.max(0, (totalMinutes - systemSettings.lunchBreak * 60) / 60);
                            }
                            
                            attendanceData.push(newRecord);
                        }
                        
                        localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                    }
                }
            });
            
            localStorage.setItem('makeupRequests', JSON.stringify(makeupRequests));
        }

        // å®šæœŸåŸ·è¡Œç³»çµ±æª¢æŸ¥
        setInterval(() => {
            dailyAnomalyCheck();
            simulateManagerReview();
        }, 60000); // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
    </script>
</body>
</html>